!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Ably=e():t.Ably=e()}(this,function(){return function(t){function e(s){if(r[s])return r[s].exports;var n=r[s]={exports:{},id:s,loaded:!1};return t[s].call(n.exports,n,n.exports,e),n.loaded=!0,n.exports}var r={};return e.m=t,e.c=r,e.p="",e(0)}([function(t,e,r){"use strict";r(2);var s=r(6),n=r(5),o=r(3),i=r(4),a=r(1),p=function(t){function e(t){for(var e,r=[],s=0;s<f.pendingSubscribers.length;s++)e=f.pendingSubscribers[s],e.matchesTest(t)?t.addSubscriber(e):r.push(e);f.pendingSubscribers=r}function r(t){if(!t.hasOwnProperty("sampler"))throw new Error("sampler is required");if("function"!=typeof t.sampler)throw new Error("sampler is expected to be a function");return t.sampler}function p(t){var e,r;for(e=0;e<t.length;e++)if(r=t[e],"function"!=typeof r.isAvailable||r.isAvailable())return r;throw new Error("no available scope provided")}function c(t){return p([t,f.scopes.memory])}function u(t){if(!t.hasOwnProperty("scope"))return c(f.scopes["default"]);if("object"==typeof t.scope)return c(t.scope);if(f.scopes.hasOwnProperty(t.scope))return c(f.scopes[t.scope]);throw new Error("scope '"+t.scope+"' not found")}var f=this;void 0===t&&(t="default"),this.namespace=t,this.tests=[],this.pendingSubscribers=[],this.samplers=o,this.scopes={memory:i.objectStorage({}),device:i.localStorage,"default":i.localStorage},this.expositionManager=new a(this.namespace),this.on=function(t,e,r){var s={test:t};"function"==typeof e?r=e:s.variant=e,s.callback=r;var o,i=new n(s);try{o=this.getTest(i.test)}catch(a){return this.pendingSubscribers.push(i),this}return o.addSubscriber(i),this},this.addTest=function(t){var n=new s({name:t.name,sampler:r(t),scope:u(t),expositionManager:this.expositionManager});return this.tests.push(n),e(n),this}};p.prototype.addTests=function(t){for(var e=0;e<t.length;e++)this.addTest(t[e]);return this},p.prototype.getTest=function(t){for(var e=0;e<this.tests.length;e++)if(this.tests[e].name===t)return this.tests[e];throw new Error("test '"+t+"' not found")},p.prototype.getTests=function(){return this.tests},p.prototype.registerScope=function(t,e){if(this.scopes.hasOwnProperty(t))throw new Error("scope '"+t+"' already registered");this.scopes[t]=e},p.prototype.purgeOldExpositions=function(t){for(var e in this.scopes)"default"!==e&&this.scopes.hasOwnProperty(e)&&this.scopes[e].isAvailable()&&this.expositionManager.purgeOldExpositions(this.scopes[e],t)},t.exports=p},function(t,e){"use strict";var r=function(t){this.namespace=t};r.prototype.getExposition=function(t,e){var r=t.load();if(null===r)return null;if(!r.hasOwnProperty("namespaces"))return null;var s=r.namespaces;if(!s.hasOwnProperty(this.namespace))return null;var n=s[this.namespace];return n.hasOwnProperty(e)?n[e]:null},r.prototype.registerExposition=function(t,e,r){var s=t.load();null===s&&(s={}),s.hasOwnProperty("namespaces")||(s.namespaces={});var n=s.namespaces;n.hasOwnProperty(this.namespace)||(n[this.namespace]={});var o=n[this.namespace];o.hasOwnProperty(e)||(o[e]={variant:r,date:new Date}),t.save(s)},r.prototype.purgeOldExpositions=function(t,e){var r=t.load();if(null!==r&&r.hasOwnProperty("namespaces")){var s=r.namespaces;if(s.hasOwnProperty(this.namespace)){var n=s[this.namespace];for(var o in n)if(n.hasOwnProperty(o)){var i,a=n[o];if("object"==typeof a.date&&a.date instanceof Date)i=a.date;else{if("string"!=typeof a.date)throw new Error("exposition date is expected to be a Date or a string");i=new Date(a.date)}e>i&&delete n[o]}t.save(r)}}},t.exports=r},function(t,e){"use strict";Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)}),t.exports={}},function(t,e){"use strict";var r={"default":function(t){return function(){var e,r,s=0,n=0;if(Array.isArray(t))return t[Math.floor(Math.random()*t.length)];if("object"!=typeof t||null===t)throw new Error("variants is expected to be an Array or an object");for(r in t)t.hasOwnProperty(r)&&(s+=t[r]);e=Math.random()*s;for(r in t)if(t.hasOwnProperty(r)){if(e<n+t[r])return r;n+=t[r]}}}};t.exports=r},function(t,e){"use strict";var r={objectStorage:function(t){return{save:function(e){t=e},load:function(){return t},isAvailable:function(){return"object"==typeof t&&null!==t}}},localStorage:{save:function(t){localStorage.setItem("__ably",JSON.stringify(t))},load:function(){return JSON.parse(localStorage.getItem("__ably"))},isAvailable:function(){var t="__test_localStorage_capability_ably_18c09e96bdd2cfe6ca47f3285f1b935d",e="12345";try{var r=window.localStorage;r.setItem(t,e);var s=r.getItem(t);return r.removeItem(t),s===e}catch(n){return!1}}}};t.exports=r},function(t,e){"use strict";var r=function(t){this.test=t.test,t.hasOwnProperty("variant")&&(this.variant=t.variant),this.callback=t.callback};r.prototype.notify=function(t){this.callback(t)},r.prototype.matchesTest=function(t){return this.test===t.name},r.prototype.matchesTestAndVariant=function(t,e){return this.hasOwnProperty("variant")?this.test===t&&this.variant===e:this.test===t},t.exports=r},function(t,e){"use strict";var r=function(t){function e(){for(var t,e=0;e<n.subscribers.length;e++)t=n.subscribers[e],t.matchesTestAndVariant(n.name,n.getAssignment())&&t.notify(n);n.subscribers=[]}function r(){var t=n.sampler(n);s(t),e()}function s(t){n.expositionManager.registerExposition(n.scope,n.name,t)}var n=this;this.name=t.name,this.sampler=t.sampler,this.scope=t.scope,this.subscribers=[],this.expositionManager=t.expositionManager,this.addSubscriber=function(t){this.subscribers.push(t),this.hasAssignment()?e():r()}};r.prototype.hasAssignment=function(){return null!==this.expositionManager.getExposition(this.scope,this.name)},r.prototype.getAssignment=function(){var t=this.expositionManager.getExposition(this.scope,this.name);return t.variant},r.prototype.purgeOldExpositions=function(t){this.expositionManager.purgeOldExpositions(this.scope,t)},t.exports=r}])});